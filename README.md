# WIFI-Chat
网络通信基于TCP/UDP
UDP服务端口	12425（用于监听单播或广播消息，服务端类是DatagramSocket）
UDP服务端口	12426（用于监听组播消息，服务端类是MulticastSocket）
TCP服务端口	12425

7.	应用层协议设计
7.1	概述
1.	本协议基于文本格式协议和二进制协议；
2.	协议包结构如下：（各字段之间以:分隔）
协议版本:包序号:发送者用户名:命令字:消息正文

协议各字段说明：
字段	类型	说明
协议版本	int	起始版本号为1，随着协议版本升级，该字段递增
包序号	int	协议包序号，递增，到达最大值后重置为0
发送者用户名	string	用户名，即用户帐号
命令字	int	协议命令字，见本文档后面说明
消息正文	string	消息内容，见本文档后面说明

7.2	命令字定义和说明
	命令字	命令字常量定义	命令字说明
功能	CMD_BR_ENTRY	0x00000001	上线通知（广播）
	CMD_ANS_ENTRY	0x00000002	确认收到上线通知
	CMD_BR_EXIT	0x00000003	下线通知（广播）
	CMD_SEND_TEXT	0x00000004	发送文本消息
	CMD_SEND_LOC	0x00000005	发送位置消息
	CMD_BR_LOC	0x00000006	广播位置
	CMD_FILE_NOTICE	0x00000007	发送附件通知消息
	CMD_RECV_MSG	0x00000009	确认收到消息
			
	CMD_GET_FILE_DATA	0x000000F0	下载文件

7.3	协议包定义
7.3.1	用户上线通知
协议包方向	用户1 -> 其他所有用户
协议类型	UDP广播
命令字	CMD_BR_ENTRY
消息正文示例	{name:'Jack',ip:'192.168.0.12'}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
name: 用户姓名
ip：手机ip地址

协议包方向	用户2 -> 用户1
协议类型	UDP
命令字	CMD_ANS_ENTRY
消息正文示例	{name:'Mike',ip:'192.168.0.12'}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
name: 用户姓名
ip：手机ip地址
7.3.2	用户下线通知
协议包方向	用户1 -> 其他所有用户
协议类型	UDP广播
命令字	CMD_BR_EXIT
消息正文示例	（消息正文为空）
消息正文说明	

消息确认协议： 无
7.3.3	发送文本消息
协议包方向	用户1 -> 用户2
协议类型	UDP
命令字	CMD_SEND_TEXT
消息正文示例	{msg_id:10,content:{text:'你好'}}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
msg_id: 消息id，取自数据库msg表里自增长id
content：消息内容
text: 文本消息字符串

协议包方向	用户2 -> 用户1
协议类型	UDP
命令字	CMD_RECV_MSG
消息正文示例	{cmd:0x00000004,packet_no:10,msg_id:100}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
cmd: 消息发送的命令字，原样返回
packet_no: 消息发送协议包的包序号，原样返回
msg_id: 消息id，原样返回

7.3.4	发送位置消息
协议包方向	用户1 -> 用户2
协议类型	UDP
命令字	CMD_SEND_LOC
消息正文示例	{msg_id:10,content:{lon:106.75648,lat:22.10821,name:'田州路159号'}}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
msg_id: 消息id，取自数据库msg表里自增长id
content：消息内容
lon, lat：经度和纬度
name: 地址名称，可为空

消息确认协议： 同“发送文本消息”的确认协议
7.3.5	实时位置广播
协议包方向	用户1 -> 其他所有用户
协议类型	UDP广播
命令字	CMD_BR_LOC
消息正文示例	{lon:106.75648,lat:22.10821}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
lon, lat：经度和纬度

消息确认协议： 无
7.3.6	发送附件通知消息
协议包方向	用户1 -> 用户2
协议类型	UDP
命令字	CMD_FILE_NOTICE
消息正文示例	{msg_id:10,content:[{uuid:'4363ca0cc35d4defa2b53c8be41b0426',type:1,name:'abc.jpg',size:11230}, ...]}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
msg_id: 消息id，取自数据库msg表里自增长id
content：消息内容
uuid：文件uuid
type: 文件类型，具体定义见数据库msg_attachment表的type字段说明
name: 文件名称
size：文件大小（单位：byte）
(3). 用户可以一次发送多个文件；

消息确认协议： 同“发送文本消息”的确认协议
7.3.7	下载文件
协议包方向	用户2 -> 用户1
协议类型	TCP
命令字	CMD_GET_FILE_DATA
消息正文示例	{uuid:'4363ca0cc35d4defa2b53c8be41b0426',offset:1024}
消息正文说明	(1). 消息正文以JSON串表示；
(2). 字段说明：
uuid：文件uuid
offset：文件下载偏移量（单位：byte），表示从哪个位置开始下载文件数据（默认为0），提供该字段是为了实现断点续传功能

接下来，用户2与用户1之间在刚建立的tcp连接上以byte stream的方式下载文件数据。
8.	客户端数据库表设计
8.1	消息表 (msg) 
字段	数据类型	默认值	注释
id	bigint		自增ID
type	tinyint		消息类型。
1：文本  2：位置  3：附件通知
content	text		消息内容。
(1). 对于文本消息，见“发送文本消息”协议消息正文的content字段内容；
(2). 对于位置消息，见“发送位置消息”协议消息正文的content字段内容；
(3). 对于附件通知消息，见“发送附件通知消息”协议消息正文的content字段内容；
msg_time	datetime		消息发送时间或接收时间。
对于当前用户发送的消息，该时间为发送时间；
对于当前用户接收的消息，该时间为接收时间；

8.2	用户消息关系表 (user_msg) 
字段	数据类型	默认值	注释
username			当前登录用户的用户名
msg_id	bigint		消息id
dir_type			消息方向。
1：当前用户发送的消息   2：当前用户收到的消息
other_username	varchar(32)		对方用户名。
对于当前用户发送的消息，对方用户为消息接收者；
对于当前用户收到的消息，对方用户为消息发送者；
other_name	varchar(128)		对方姓名
status	tinyint		消息发送状态，该字段只对当前用户发送的消息有效。
0：正在发送
1：发送出错，或对方未收到消息
2：对方已收到消息
is_read	tinyint		当前用户是否已读消息，该字段只对当前用户收到的消息有效。
0：当前用户未读  1：当前用户已读

8.3	消息附件表 (msg_attachment)
字段	数据类型	默认值	注释
id	bigint		系统自增ID
msg_id	bigint		消息id（这里为附件通知消息的id）
file_uuid	varchar(48)		附件uuid
type	tinyint		附件类型。
1：照片  2：音频  3：视频  4：文件
filename	varchar(128)		文件名称
size	bigint		文件大小，单位：byte
uri	varchar(1024)		文件本地存储路径。
对于文件发送方，该字段为发送文件所存储在本地的路径；
对于文件接收方，该字段为接收文件所保存在本地的路径。
status	tinyint		文件下载状态，对于当前用户接收文件有效。
0：下载未完成  1：下载完成
